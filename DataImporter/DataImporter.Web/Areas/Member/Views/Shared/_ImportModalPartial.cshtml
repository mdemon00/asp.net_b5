<script src="/lib/dropzone/dropzone.min.js" type="text/javascript"></script>


<div class="modal fade" id="importModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header no-bd">
                <h5 class="modal-title">
                    <span class="fw-mediumbold">
                        New
                    </span>
                    <span class="fw-light">
                        Upload
                    </span>
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form class="dropzone">
                    <div class="dz-message" data-dz-message>
                        <div class="icon">
                            <i class="flaticon-file"></i>
                        </div>
                        <h4 class="message">Drag and Drop files here</h4>
                        <div class="note">(This is just a demo dropzone. Selected files are <strong>not</strong> actually uploaded.)</div>
                    </div>
                    <div class="fallback">
                        <input name="file" type="file" multiple />
                    </div>
                </form>
            </div>

            <div class="modal-footer no-bd">
                <div class="form-group mr-auto w-50" id="gp2">
                    <label style="position: absolute;margin-top: -29px; width: 50%;">Select a group where to Import.</label>
                    <div class="select2-input">
                        <select id="gropuNames2" name="gropuNames2" class="form-control" style="width: 85%">
                        </select>
                    </div>
                </div>

                <input type="hidden" id="tempStore" value="" />
                <button type="button" id="importButton" class="btn btn-primary">Import</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>


<script>
    $("#gropuNames2").select2({
        dropdownParent: $('#gp2'),
        placeholder: "Select..",
        theme: "bootstrap",
        ajax: {
            type: "GET",
            url: "/api/GroupApi/Search",
            contentType: "application/json; charset=utf-8",
            data: function (params) {
                var query =
                {
                    term: params.term,
                };
                return query;
            },
            processResults: function (result) {
                return {
                    results: $.map(result, function (item) {
                        return {
                            id: item.id,
                            text: item.name
                        };
                    }),
                };
            }
        }
    });

    $("#importButton").click(function (evt) {

        try {
            var fileName = $('#tempStore').val();
            var groupName = $('#gropuNames2').select2('data')[0].text;
        }
        catch (err) {
            console.log(err);
        }

        if (!fileName || fileName.length === 0) {
            swal("Error", "Please Upload a file first!", {
                icon: "error",
                buttons: {
                    confirm: {
                        className: 'btn btn-danger'
                    }
                },
            });
        }
        else if (!groupName || groupName.length === 0) {
            swal("Error", "Group not selected!", {
                icon: "error",
                buttons: {
                    confirm: {
                        className: 'btn btn-danger'
                    }
                },
            });
        }
        else {
            $.ajax({
                url: '/member/contact/Import',
                data: {
                    GroupName: groupName,
                    FileName: fileName,
                },
                type: "POST",
                beforeSend: function () {
                    $('#importButton').addClass("is-loading");
                },
                success: function (response) {
                    $('#importButton').removeClass("is-loading");
                    $('#importModal').modal('hide');
                },
                complete: function (response) {
                    if (response.status == 200) {
                        swal("Done", "Imported successfully", {
                            icon: "success",
                            buttons: {
                                confirm: {
                                    className: 'btn btn-success'
                                }
                            },
                        });

                        var def = $.Deferred();
                        def.then($('#contacts').DataTable().destroy(), $.fn.GetColumns(response.GroupName));
                    }
                    else {
                        $('#importButton').removeClass("is-loading");

                        swal("Failed", response.responseText, {
                            icon: "error",
                            buttons: {
                                confirm: {
                                    className: 'btn btn-danger'
                                }
                            },
                        });
                    }
                },
                failure: function (jqXHR, textStatus, errorThrown) {
                    alert("HTTP Status: " + jqXHR.status + "; Error Text: " + jqXHR.responseText); // Display error message
                }
            });
        }
    });
</script>